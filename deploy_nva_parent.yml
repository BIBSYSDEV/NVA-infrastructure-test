AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: Deployment of NVA from SAR

Parameters:

  DomainCertificateArn:
    Type: String
    Description: ARN  of certificate to assign to the assosiated Domain
    Default: arn:aws:acm:us-east-1:812481234721:certificate/9319e9f9-3a66-43bb-9f9c-7fc1e6b4d3ab

  RedirectSignInUrl:
    Type: String
    Default: https://frontend.test.nva.aws.unit.no
  RedirectSignOutUrl:
    Type: String
    Default: https://frontend.test.nva.aws.unit.no/logout

  BareApiKey:
    Type: String
    Description: Key to access bare
    NoEcho: true
    Default: '{{resolve:secretsmanager:bareApiKey:SecretString}}'
  BareHost:
    Type: String
    Description: Address to bare
    Default: alfa-a.bibsys.no
  AlmaSruHost:
    Type: String
    Description: Address to Alma-SRU
    Default: bibsys.alma.exlibrisgroup.com/view/sru/47BIBSYS_NETWORK
  OrcidBaseUrl:
    Type: String
    Description: Address to ORCID services
    Default: https://sandbox.orcid.org
  OrcidClientID:
    Type: String
    Description: Clientid for ORCID
    Default: APP-QHBJSU99SZV1LMQJ
  OrcidClientSecret:
    Type: String
    Description: Secret to authenticate for ORCID
    NoEcho: true
    Default: '{{resolve:secretsmanager:REACT_APP_ORCID_CLIENT_SECRET:SecretString}}'
  OrcidRedirectUri:
    Type: String
    Description: RedirectUrl after login to ORCID
    Default: https://frontend.test.nva.aws.unit.no/user
  AlmaApiUrl:
    Type: String
    Description: URL to ALMA Library services
    Default: https://bibsys.alma.exlibrisgroup.com/view/sru/47BIBSYS_NETWORK



Resources:

# ===============================
#  Domene
# ===============================

# ===============================
#  Cognito
# ===============================

  NVACognito:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: "https://nva-infrastructure-test.s3-eu-west-1.amazonaws.com/template_cognito.yml"

# ===============================
#  DynamoDB
# ===============================

# ===============================
#  S3 Storage
# ===============================

# ===============================
#  Frontend
# ===============================

  NVAFrontend:
    Type: AWS::Serverless::Application
    Description: NVA Frontend
    Properties:
      Location:
        ApplicationId: arn:aws:serverlessrepo:eu-west-1:884807050265:applications/NVA-Frontend
        SemanticVersion: 1.1.2
      Parameters:
        AlmaApiUrl: !Ref AlmaApiUrl
        AmazonCognitoDomain: !ImportValue AuthDomain
        FrontendDomain: !ImportValue FrontendDomain
        BackendDomain: !ImportValue BackendApiDomain
        DomainCertificateArn: !Ref DomainCertificateArn
        CognitoIdentityPoolId: !ImportValue CognitoIdentityPoolId
        UserPoolId: !ImportValue CognitoUserPoolId
        UserPoolAppClientId: !ImportValue CognitoUserPoolAppClientId
        RedirectSignInUrl: !Ref RedirectSignInUrl
        RedirectSignOutUrl: !Ref RedirectSignOutUrl
        OrcidBaseUrl: !Ref OrcidBaseUrl
        OrcidClientID: !Ref OrcidClientID
        OrcidClientSecret: !Ref OrcidClientSecret
        OrcidRedirectUri: !Ref OrcidRedirectUri

# ===============================
#  API / Backend
# ===============================
  BackendLambdas:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: "https://nva-infrastructure-test.s3-eu-west-1.amazonaws.com/deploy_backend.yml"
      Parameters:
        CognitoAuthorizerArn: !ImportValue CognitoUserPoolId
        BackendDomain: !ImportValue BackendApiDomain
        BareApiKey: !Ref BareApiKey
        BareHost: !Ref BareHost
        AlmaSruHost: !Ref AlmaSruHost

